{% extends "base.html" %}
{% load static %}
{% load custom_filters %} {# Eger arnawlı filtrler (mısalı, qaraqalpaqsha sáne) bolsa #}

{# --- META TEGLARDI QAYTA ANÍQLAW --- #}
{% block title %}{{ article.title }} - Kózqaras{% endblock title %}

{% block meta_description %}{{ article.content|striptags|truncatewords:25 }}{% endblock meta_description %}

{# Keywords (kerek bolsa) #}
{% block meta_keywords %}{% for cat in article.categories.all %}{{ cat.name }}, {% endfor %}{{ article.title }}, {{ block.super }}{% endblock meta_keywords %}
{% block meta_author %}{{article.author.full_name}}{% endblock meta_author %}

{# Canonical URL #}

{# Open Graph #}
{% block og_type %}maqala{% endblock og_type %}
{% block og_title %}{{ article.title }}{% endblock og_title %}
{% block og_description %}{{ article.content|striptags|truncatewords:25 }}{% endblock og_description %}
{% block og_image %}{% if full_image_url %}{{ full_image_url }}{% else %}{{ block.super }}{% endif %}{% endblock og_image %}
{% block og_image_alt %}{{ article.title }} súwreti{% endblock %}
{# Maqalaǵa tán OG teglar (kerek bolsa) #}
<meta property="article:published_time" content="{{ article.published_date|date:'c' }}"> {# ISO 8601 formatında sáne #}
<meta property="article:modified_time" content="{{ article.updated_at|date:'c' }}">
{% for cat in article.categories.all %}
<meta property="article:section" content="{{ cat.name }}">
{% endfor %}
{% if article.author %}
<meta property="article:author" content="{{ article.author.slug }}"> {# Avtor profili URL'i (eger bar bolsa) #}
{% endif %}

{# Twitter Cards (og tegların qaytalaydı) #}
{% block twitter_title %}{{ self.og_title_inner.content }}{% endblock twitter_title %}
{% block twitter_description %}{{ self.og_description.content }}{% endblock twitter_description %}
{% block twitter_image %}{{ self.og_image.content }}{% endblock twitter_image %}
{% block twitter_image_alt %}{{ self.og_image_alt.content }}{% endblock %}
{# <meta name="twitter:creator" content="@avtor_twitter_akkaunti"> #} {# Eger Avtor modelinde twitter handle bolsa #}
{# --- META TEGLAR AQırı --- #}


{% block content %}
  <article >
    {# Súwret (eger bar bolsa) #}
    {% if article.featured_image %}
      {# Súwrettiń biyikligin anıq belgilewden góre, aspect-ratio qollanıw jaqsıraq #}
      <div class="mb-4 overflow-hidden rounded-3" style="aspect-ratio: 16 / 9;">
         <img src="{{ article.featured_image.url }}" class="img-fluid" alt="{{ article.title }} súwreti" style="width: 100%; height: 100%; object-fit: cover;">
      </div>
    {% endif %}

    {# Atama hám metadata #}
    <header class="mb-4"> {# text-center alıp taslandı #}
       <h1 class="article-title-main mb-3">{{ article.title }}</h1>
       <p class="article-meta text-secondary small">
            {% if article.author %}
            {# Avtor profili betine silteme (házirshe #) #}
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-person-fill me-1 mb-1" viewBox="0 0 16 16"><path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6"/></svg>
            <a href="{{ article.author.get_absolute_url }}" class="link-secondary text-decoration-none">{{ article.author.full_name }}</a>
            <span class="mx-2">|</span>
            {% endif %}
            {{ article.published_date|format_kaa_date }}
            <span class="mx-2">|</span>
            <svg xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" fill="currentColor" class="bi bi-eye-fill me-1 mb-1" viewBox="0 0 16 16"><path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0z"/><path d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8zm8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7z"/></svg>
            {{ article.view_count }}
        </p>
       {# Kategoriyalardı usı jerge shıǵarıw jaqsıraq #}
        <div class="mt-3 article-tags-header"> {# Jańa klass #}
            {% if article.categories.all %}
              {% for cat in article.categories.all %}
              <span class="badge rounded-pill bg-primary-subtle text-primary-emphasis border border-primary-subtle fw-normal mb-1">
                  {{ cat.name }}
              </span>
              {% endfor %}
            {% endif %}
        </div>
    </header>

    <hr class="my-4"> {# Mazmun aldına ajıratıwshı sızıq #}

    {# Maqala mazmunı #}
    <div class="article-content">
        {{ article.content|safe }}
    </div>

    {# Telegram Kommentariyalar (eger URL kórsetilgen bolsa) #}
    {% if article.telegram_post_url %} {# <<< TEKSERIW QOSÍLDÍ >>> #}
        <div class="mt-5 pt-4 border-top border-secondary-subtle">
        <h3 class="mb-3 h4">Pikir bildiriw</h3>
        {# Vidjet ushın orın (ID hám jańa data atributı menen) #}
        <div id="telegram-comments-container" data-discussion-url="{{ article.telegram_post_url }}"> {# <<< URL DATA ATRIBUTÍNA BERILDI >>> #}
            {# Vidjet JS arqalı qosıladı #}
        </div>
        <noscript>Pikirlerdi kóriw ushın JavaScriptti aktivlestiriń.</noscript>
        </div>
    {% endif %} {# <<< TEKSERIW AQIRI >>> #}
  </article>

  
    {% if request.GET.b != 'False' %}
        <div class="mt-5 text-center border-top border-secondary-subtle pt-4">
            <a href="{% url 'article_list' %}" class="btn btn-outline-secondary">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-left" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8"/>
                </svg> 
                <span>Barlıq maqalalar</span>
            </a>
        </div>
    {% endif %}

{% endblock %}

{% block extra_js %} {# <-- Bettiń ózine tán JavaScript ushın blok #}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const commentsContainer = document.getElementById('telegram-comments-container');
        // <<< Konteyner bar bolsa ǵana islew >>>
        if (commentsContainer && commentsContainer.dataset.discussionUrl) { // <<< URL bar ekenin de tekseriw >>>
    
            const discussionUrl = commentsContainer.dataset.discussionUrl; // <<< URL di alıw >>>
    
            // Telegram vidjetin jańalaw funkciyası
            const updateTelegramWidgetThemeLocal = (theme) => {
                // Eski vidjetti alıp taslaw
                while (commentsContainer.firstChild) {
                    commentsContainer.removeChild(commentsContainer.firstChild);
                }
    
                // Jańa vidjet skriptin jaratıw
                const script = document.createElement('script');
                script.async = true;
                script.src = 'https://telegram.org/js/telegram-widget.js?22';
    
                // <<< data-telegram-discussion di dinamik belgilew >>>
                // URL den kanal/gruppa hám post ID ni ajıratıp alıw kerek
                // Mısal: https://t.me/kanal_ati/1234 -> kanal_ati/1234
                let discussionData = '';
                try {
                    const urlParts = new URL(discussionUrl);
                    const pathParts = urlParts.pathname.split('/').filter(part => part); // Bos elementlerdi alıp taslaw
                    if (pathParts.length >= 2) {
                        discussionData = `${pathParts[pathParts.length - 2]}/${pathParts[pathParts.length - 1]}`;
                    } else {
                       console.error("Telegram URL formatı nadurıs:", discussionUrl);
                    }
                } catch (e) {
                    console.error("Telegram URL analizinde qátelik:", discussionUrl, e);
                    discussionData = discussionUrl; // Eger analiz islemese, URL diń ózin jiberip kóriw
                }
    
                if (discussionData) { // Eger durıs format tabılsa
                     script.setAttribute('data-telegram-discussion', discussionData);
                } else {
                     console.warn("Telegram pikirleri ushın data-telegram-discussion anıqlanbadı.");
                     return; // Skriptti qospaw
                }
                // <<< DINAMIK BELGILEW AQIRI >>>
    
    
                script.setAttribute('data-comments-limit', '10');
                script.setAttribute('data-width', '100%');
                if (theme === 'dark') {
                    script.setAttribute('data-dark', '1');
                } else {
                    script.setAttribute('data-dark', '0');
                }
                commentsContainer.appendChild(script);
            }
    
            // Dáslepki temanı alıp, birinshi ret vidjetti júklew
            const initialTheme = document.documentElement.getAttribute('data-bs-theme') || 'dark'; // || 'dark' qosıldı
            updateTelegramWidgetThemeLocal(initialTheme);
    
            // 'themeChanged' járiyasın tıńlaw
            document.addEventListener('themeChanged', (event) => {
                if (event.detail && event.detail.theme) {
                    updateTelegramWidgetThemeLocal(event.detail.theme);
                }
            });
        } // <<< if commentsContainer ... aqırı >>>
    });
</script>
{% endblock %}